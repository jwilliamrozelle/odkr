library(odkr)
context("Check pull_remote output")

test_that("Error for no target", {
  expect_error(pull_remote(sd = TRUE,
                           id = "stakeholders",
                           from = "https://ona.io/validtrial",
                           to = dirPath,
                           username = "validtrial",
                           password = "zEF-STN-5ze-qom"),
               "Cannot locate ODK Briefcase .jar file. Check target location of .jar file is correct.")
})

test_that("Error for no id", {
  expect_error(pull_remote(target = dirPath,
                           sd = TRUE,
                           from = "https://ona.io/validtrial",
                           to = dirPath,
                           username = "validtrial",
                           password = "zEF-STN-5ze-qom"),
               "Form id not specified. Try again.")
})

test_that("Error for no from", {
  expect_error(pull_remote(target = dirPath,
                           sd = TRUE,
                           id = "stakeholders",
                           to = dirPath,
                           username = "validtrial",
                           password = "zEF-STN-5ze-qom"),
               "URL of remote ODK Aggregate not specified. Try again.")
})

test_that("Error for no to", {
  expect_error(pull_remote(target = dirPath,
                           sd = TRUE,
                           id = "stakeholders",
                           from = "https://ona.io/validtrial",
                           username = "validtrial",
                           password = "zEF-STN-5ze-qom"),
               "Cannot locate destination folder for ODK Briefcase Storage. Check destination location is correct.")
})

test_that("Successful pull of encrypted forms", {

  if(!file.exists(paste0(dirPath, "/odkBriefcase_latest"))) {
    get_briefcase(dirPath)
  }

  # identify the directory that will be used in testing
  form_name <- "odkr_encrypted_Test"
  odkbc_test_path <- paste0(dirPath, "/ODK Briefcase Storage/forms/", form_name)

  # clean up
  ## When the test finishes, delete the variable
  on.exit(rm(odkbc_test_path),
          add = TRUE,
          after = FALSE)
  ## When the test finishes, delete the downlaoded directory
  on.exit(unlink(odkbc_test_path, recursive = TRUE),
          add = TRUE,
          after = FALSE)

  expect_equal(pull_remote(target= dirPath,
                           sd = TRUE,
                           id = form_name,
                           username = "validtrial",
                           password = "zEF-STN-5ze-qom",
                           from = "https://odk.ona.io/validtrial",
                           to = dirPath),
               0)
})
